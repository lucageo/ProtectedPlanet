#!/bin/bash
# sidekiq    Init script for Sidekiq
# chkconfig: 345 100 75
#
# Description: Starts and Stops Sidekiq message processor
#
# User-specified exit parameters used in this script:
#
# Exit Code 5 - Incorrect User ID
# Exit Code 6 - Directory not found


# You will need to modify these
APP="pp"
AS_USER="ubuntu"
APP_DIR="/var/www/${APP}/current"
APP_ENV="{{stage}}"

RETVAL=0


start() {

  status
  if [ $? -eq 1 ]; then

    [ `id -u` == '0' ] || (echo "sidekiq runs as root only .."; exit 5)
    [ -d $APP_DIR ] || (echo "$APP_DIR not found!.. Exiting"; exit 6)

    {% for process in sidekiq_processes %}
      LOG_FILE="$APP_DIR/log/{{ process.name }}.log"
      PID_FILE="$APP_DIR/tmp/${APP}-{{ process.name }}.pid"
      QUEUES="{{ process.queues|join(' -q ') }}"

      START_CMD="bundle exec sidekiq -e $APP_ENV -P $PID_FILE -q $QUEUES"
      CMD="cd ${APP_DIR}; ${START_CMD} >> ${LOG_FILE} 2>&1 &"

      echo "Starting sidekiq ({{ process.name }}) message processor .. "
      su -c "$CMD" - $AS_USER

      RETVAL=$?
      #Sleeping for 8 seconds for process to be precisely visible in process table - See status ()
      sleep 8
    {% endfor %}
    return $RETVAL
  else
    echo "sidekiq message processor is already running .. "
  fi

}

stop() {

  {% for process in sidekiq_processes %}
    PID_FILE="$APP_DIR/tmp/${APP}-{{ process.name }}.pid"
    CMD="cd $APP_DIR; bundle exec sidekiqctl stop $PID_FILE"

    echo "Stopping sidekiq ({{ process.name }}) message processor .."
    su -c "$CMD" - $AS_USER

    RETVAL=$?
  {% endfor %}
  return $RETVAL

}

status() {

  ps -ef | grep 'sidekiq [0-9].[0-9].[0-9]' | grep -v grep
  [ $? -eq 0 ] || return $?

  {% for process in sidekiq_processes %}
    PID_FILE="$APP_DIR/tmp/${APP}-{{ process.name }}.pid"

    cat $PID_FILE 2>&1 | xargs ps -p > /dev/null
    [ $? -eq 0 ] || return $?
  {% endfor %}

  return 0

}


case "$1" in
    start)
        start
        ;;
    stop)
        stop
        ;;
    status)
        status

        if [ $? -eq 0 ]; then
             echo "sidekiq message processor is running .."
             RETVAL=0
         else
             echo "sidekiq message processor is stopped .."
             RETVAL=1
         fi
        ;;
    *)
        echo "Usage: $0 {start|stop|status}"
        exit 0
        ;;
esac
exit $RETVAL

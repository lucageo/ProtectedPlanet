UPDATE countries
SET <%= area_type %>_pas_geom = a.the_geom
FROM (
 SELECT ST_UNION(the_geom) as the_geom
 FROM (
   SELECT  iso3, <%= geometry_attribute(country, area_type) %> the_geom FROM standard_polygons pol
     WHERE pol.iso3 = '<%= country.iso_3 %>'
      AND st_isvalid(pol.wkb_geometry)
      AND pol.marine = '<%= marine_status %>'
      AND pol.status NOT IN ('Proposed', 'Not Reported')

   UNION

   SELECT iso3, buffer_geom the_geom FROM standard_points poi
     WHERE poi.iso3 = '<%= country.iso_3 %>'
      AND st_isvalid(poi.buffer_geom)
      AND poi.marine = '<%= marine_status %>'
      AND poi.status NOT IN ('Proposed', 'Not Reported')

   UNION

   SELECT c.iso_3, ST_Makevalid(ST_Intersection(c.land_geom,s.wkb_geometry)) FROM standard_polygons s
     INNER JOIN countries c ON ST_Intersects(c.land_geom,s.wkb_geometry)
     WHERE s.iso3 LIKE '%,%'
      AND c.iso_3 = '<%= country.iso_3 %>'
      AND poi.marine = '<%= marine_status %>'
      AND poi.status NOT IN ('Proposed', 'Not Reported')
  ) b
) a
WHERE iso_3 = '<%= country.iso_3 %>'
